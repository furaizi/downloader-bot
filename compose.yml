name: downloader-bot

services:
  redis:
    image: redis:7-alpine
    container_name: redis
    mem_limit: 256m
    command: ["redis-server", "--appendonly", "yes", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -h 127.0.0.1 -p 6379 ping | grep PONG"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  app:
    image: ghcr.io/furaizi/downloader-bot:${IMAGE_TAG:-latest}
#    build: .
    depends_on:
      redis:
        condition: service_healthy
      fix-perms:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
      - "8081:8081"
    env_file:
      - .env
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?set TELEGRAM_BOT_TOKEN}
      TELEGRAM_BOT_USERNAME: ${TELEGRAM_BOT_USERNAME:?set TELEGRAM_BOT_USERNAME}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-}
      SPRING_DOCKER_COMPOSE_ENABLED: "false"
      SPRING_DATA_REDIS_HOST: redis
      INSTALOADER_SESSION_FILE: /app/secrets/instaloader-session
      YTDLP_COOKIES_FILE: /app/secrets/ytdlp-cookies.txt
    mem_limit: 1500m
    cpus: "1.5"
    pids_limit: 256
    cap_drop:
      - ALL
#    security_opt:
#      - no-new-privileges:true
    volumes:
      - downloads:/downloads
      - ./secrets:/app/secrets
      - ./config:/app/config
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 67108864   # 64 MiB
          mode: 1777
    healthcheck:
      test: ["CMD", "/usr/local/bin/busybox", "wget", "-q", "-O", "/dev/null", "http://localhost:8081/actuator/health/readiness"]
      interval: 10s
      timeout: 3s
      retries: 6
      start_period: 30s

  fix-perms:
    image: busybox:1.36
    command: [ "sh","-c","mkdir -p /downloads && chown -R 65532:65532 /downloads && chmod 755 /downloads" ]
    volumes:
      - downloads:/downloads
    restart: "no"
    labels:
      org.springframework.boot.ignore: "true"

  prometheus:
    image: prom/prometheus:latest
    profiles:
      - monitoring
    ports:
        - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/prometheus/rules.yml:/etc/prometheus/rules/rules.yml
    depends_on:
      - app

  redis_exporter:
    image: oliver006/redis_exporter:latest
    profiles:
      - monitoring
    environment:
      REDIS_ADDR: redis:6379
    ports:
      - "9121:9121"
    depends_on:
      - redis

  grafana:
    image: grafana/grafana:latest
    profiles:
      - monitoring
    ports:
        - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
      - ./monitoring/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/downloader-bot.yml
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
      - ./monitoring/grafana/alerting:/etc/grafana/provisioning/alerting
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_USERS_ALLOW_SIGN_UP: "false"
    depends_on:
      - prometheus


volumes:
  downloads:
  redis-data:
  grafana-data:
