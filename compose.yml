name: downloader-bot

services:
  redis:
    image: redis:7-alpine
    container_name: redis
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  app:
    depends_on:
      - redis
    build: .
    ports:
      - "8080:8080"
      - "8081:8081"
    env_file:
      - .env
    environment:
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?set TELEGRAM_BOT_TOKEN}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-}
      SPRING_DOCKER_COMPOSE_ENABLED: "false"
      SPRING_DATA_REDIS_HOST: redis
    volumes:
      - downloads:/downloads

  fix-perms:
    image: busybox:1.36
    command: [ "sh","-c","mkdir -p /downloads && chown -R 65532:65532 /downloads && chmod 755 /downloads" ]
    volumes:
      - downloads:/downloads
    restart: "no"
    labels:
      org.springframework.boot.ignore: "true"

  prometheus:
    image: prom/prometheus:latest
    profiles:
      - monitoring
    ports:
        - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - app

  redis_exporter:
    image: oliver006/redis_exporter:latest
    profiles:
      - monitoring
    environment:
      REDIS_ADDR: redis:6379
    ports:
      - "9121:9121"
    depends_on:
      - redis

  grafana:
    image: grafana/grafana:latest
    profiles:
      - monitoring
    ports:
        - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    depends_on:
      - prometheus


volumes:
  downloads:
  redis-data:
  grafana-data:
