name: Deploy to EC2

on:
  release:
    types: [ published ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  packages: read

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Resolve image tag and repo ref
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
            echo "image_tag=${TAG#v}" >> $GITHUB_OUTPUT
            echo "repo_ref=${TAG}"    >> $GITHUB_OUTPUT
          else
            echo "image_tag=latest"   >> $GITHUB_OUTPUT
            echo "repo_ref=main"      >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS creds (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          aws-region:     ${{ vars.AWS_REGION }}

      - name: Deploy via SSM
        env:
          EC2_INSTANCE_ID: ${{ vars.INSTANCE_ID }}
          EC2_APP_DIR:     ${{ vars.APP_DIR }}

          EC2_IMAGE_NAME:  ${{ env.IMAGE_NAME }}
          EC2_IMAGE_TAG:   ${{ steps.tag.outputs.image_tag }}
          EC2_REPO_REF:    ${{ steps.tag.outputs.repo_ref }}
          EC2_REPOSITORY: ${{ github.repository }}

          EC2_SPRING_PROFILES_ACTIVE: ${{ vars.SPRING_PROFILES_ACTIVE }}
          EC2_TELEGRAM_BOT_TOKEN:     ${{ secrets.TELEGRAM_BOT_TOKEN }}
          EC2_GRAFANA_ADMIN_USER:     ${{ vars.GRAFANA_ADMIN_USER }}
          EC2_GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        run: |
          set -euo pipefail
        
          TEMP_DEPLOY="/tmp/deploy"
          DEPLOY_ENV=$(
            for v in $(compgen -A variable | grep '^EC2_'); do
              clean="${v#EC2_}"
              printf "%s=%s\n" "$clean" "${!v}"
            done
          )
          ENV_B64=$(printf '%s' "$DEPLOY_ENV" | base64 -w0)
          DEPLOY_SH_URL="https://raw.githubusercontent.com/$EC2_REPOSITORY/$EC2_REPO_REF/scripts/deploy.sh"

          read -r -d '' PARAMS_JSON <<EOF || true
          {
            "commands": [
              "echo '$ENV_B64' | base64 -d > '$TEMP_DEPLOY.env'",
              "set -a",
              ". '$TEMP_DEPLOY.env'",
              "set +a",
              "curl -fsSL '$DEPLOY_SH_URL' -o '$TEMP_DEPLOY.sh'",
              "chmod +x '$TEMP_DEPLOY.sh'",
              "/usr/bin/env bash -euo pipefail '$TEMP_DEPLOY.sh'",
              "rm -f '$TEMP_DEPLOY.env' '$TEMP_DEPLOY.sh'"
            ],
            "executionTimeout": ["3600"]
          }
          EOF
          
          COMMAND_ID=$(aws ssm send-command \
            --cli-binary-format raw-in-base64-out \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy downloader-bot $EC2_IMAGE_NAME:$EC2_IMAGE_TAG" \
            --parameters "$PARAMS_JSON" \
            --query "Command.CommandId" \
            --output text)
          
          echo "SSM CommandId: $COMMAND_ID"
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$EC2_INSTANCE_ID"
          
          RES_JSON=$(aws ssm list-command-invocations \
            --command-id "$COMMAND_ID" \
            --details \
            --output json)
          STATUS=$(echo "$RES_JSON" | jq -r '.CommandInvocations[0].Status')
          EXIT_CODE=$(echo "$RES_JSON" | jq -r '.CommandInvocations[0].CommandPlugins[0].ResponseCode')
          OUT=$(echo "$RES_JSON" | jq -r '.CommandInvocations[0].CommandPlugins[0].Output // ""')
          ERR_URL=$(echo "$RES_JSON" | jq -r '.CommandInvocations[0].CommandPlugins[0].StandardErrorUrl // empty')
          
          echo "SSM Status: $STATUS"
          echo "ExitCode: ${EXIT_CODE:-unknown}"
          echo "----- STDOUT -----"
          echo "$OUT"
          [ -n "$ERR_URL" ] && echo "STDERR URL: $ERR_URL"

          if [ "$STATUS" != "Success" ] || [ "${EXIT_CODE:-0}" -ne 0 ]; then
            echo "Deployment failed via SSM"
            exit 1
          fi
          
          
